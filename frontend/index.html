<!-- frontend/index.html -->
<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>PhishGuard Prototype</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        textarea {
            width: 100%;
            height: 100px;
        }
        
        #alerts {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow: auto;
        }
        
        .alert {
            background: #ffecec;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 4px solid #ff5c5c;
        }
    </style>
</head>

<body>
    <h2>PhishGuard Prototype</h2>

    <div id="auth">
        <h3>Register / Login</h3>
        <input id="email" placeholder="email" /><input id="name" placeholder="name (register)" />
        <input id="password" placeholder="password" type="password" />
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
        <div id="user"></div>
    </div>

    <hr/>
    <h3>Classify text</h3>
    <input id="subject" placeholder="Subject" style="width:100%" />
    <textarea id="body"></textarea>
    <button onclick="classify()">Classify</button>
    <div id="result"></div>

    <h4>Feedback</h4>
    <input id="fb_email_id" placeholder="email id" />
    <select id="fb_label"><option value="phish">phish</option><option value="legit">legit</option></select>
    <input id="fb_comment" placeholder="comment" />
    <button onclick="sendFeedback()">Send feedback</button>

    <h3>Real-time Alerts</h3>
    <div id="alerts"></div>

    <script>
        let token = null;
        async function register() {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('password').value;
            const name = document.getElementById('name').value;
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email,
                    password: pw,
                    name
                })
            });
            const js = await res.json();
            alert(JSON.stringify(js));
        }
        async function login() {
            const email = document.getElementById('email').value;
            const pw = document.getElementById('password').value;
            // using OAuth2 password flow endpoint expects form-encoded
            const fd = new URLSearchParams();
            fd.append('username', email);
            fd.append('password', pw)
            const res = await fetch('/api/token', {
                method: 'POST',
                body: fd
            });
            const js = await res.json();
            if (js.access_token) {
                token = js.access_token;
                document.getElementById('user').innerText = "Logged in as " + email;
                connectWs();
            } else alert(JSON.stringify(js));
        }

        async function classify() {
            if (!token) {
                alert('login first');
                return;
            }
            const subject = document.getElementById('subject').value;
            const text = document.getElementById('body').value;
            const fd = new FormData();
            fd.append('text', text);
            fd.append('subject', subject);
            const res = await fetch('/api/classify', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                body: fd
            });
            const js = await res.json();
            document.getElementById('result').innerText = JSON.stringify(js, null, 2);
        }

        async function sendFeedback() {
            if (!token) {
                alert('login first');
                return;
            }
            const email_id = document.getElementById('fb_email_id').value;
            const label = document.getElementById('fb_label').value;
            const comment = document.getElementById('fb_comment').value;
            const res = await fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    email_id: parseInt(email_id),
                    label,
                    comment
                })
            });
            const js = await res.json();
            alert(JSON.stringify(js));
        }

        function connectWs() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(protocol + '//' + location.host + '/ws/notifications');
            ws.onopen = () => console.log('ws open');
            ws.onmessage = (evt) => {
                const data = JSON.parse(evt.data);
                const div = document.createElement('div');
                div.className = 'alert';
                div.innerText = `[${data.type}] ${data.summary} (conf ${data.confidence}) id:${data.email_id}`;
                document.getElementById('alerts').prepend(div);
            }
        }
    </script>
</body>

</html>